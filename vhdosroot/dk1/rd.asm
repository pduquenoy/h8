
	TITLE	'RDDVD - ND DEVICE DRIVER'
	EJECT
***	RDDVD - RD DEVICE DRIVER.
*
*	J.G. LETWIN
*       SMBAKER
*
*       notes
*          AIO.UNI is unit number 


	XTEXT	ASCII
	XTEXT	DDDEF
	XTEXT	HOSDEF
	XTEXT	HOSEQU
	XTEXT	ECDEF
	XTEXT	ESVAL
	XTEXT	DEVDEF
	XTEXT	FILDEF
	XTEXT	PICDEF
	XTEXT	DVDDEF
	XTEXT	SETCAL
	XTEXT   PGREG

	CODE	PIC

RDCAP EQU     DT.CW+DT.CR+DT.DD+DT.RN         Read, Write, Directory, Random

	DB	DVDFLV		DEVICE DRIVER FLAG VALUE
	DB	RDCAP
	DB	00000001B	MOUNTED UNIT MASK
	DB	1		ONLY 1 UNIT
	DB	RDCAP
	DS	7		1-7:  IGNORED
	DB	DVDFLV		DEVICE DRIVER FLAG
	DW	0		No INIT Parameters		/80.09.gc/

.	SET	025Q						/80.09.gc/
	ERRNZ	*-.						/80.09.gc/
	ERRMI	DVD.STE-.					/80.09.gc/
	DS	DVD.STE-.	RESERVED AREAS			/80.09.gc/
	STL	'SET CODE'
	EJECT
***	SET CODE ENTRY POINT
*
*
*	ENTRY:	(DE)	=  LINE POINTER
*		(A)	=  UNIT NUMBER
*
*	EXIT:	(PSW)	=  'C' CLEAR IF NO ERROR
*			=  'C' SET   IF    ERROR
*
*	USES:	ALL
*

SETNTR	EQU	*
	ERRNZ	*-DVD.STE
	ANA	A
	JNZ	SET1
	MOV	B,D
	MOV	C,E		(BC) = PARAMETER LIST ADDRESS
	LXI	D,PRCTAB	(DE) = PROCESSOR TABLE ADDRESS
	LXI	H,OPTTAB	(HL) = OPTION TABLE ADDRESS
	CALL	$SOP
	RC			THERE WAS AN ERROR
	CALL	$SNA
	RZ			AT THE END OF THE LINE
	MVI	A,EC.ILO
	STC
	RET

SET1	MVI	A,EC.UUN	UNKNOWN UNIT NUMBER
	STC
	RET
	STL	'PROCESSORS'
	EJECT
***	PROCESSORS
*
	SPACE	4,10
**	HELP	-  PROCESS HELP OPTION
*
*	LIST THE VALID OPTIONS ON THE USER CONSOLE
*

HELP	CALL	$TYPTX
	DB	NL,NL,'Set Options for ND:',NL,NL
	DB	'HELP	Type this message',NL
	DB	NL
	DB	'NOTE:	This is the only valid option for the NULL device',NL
	DB	NL,ENL
	XRA	A
	RET
	STL	'SET TABLES'
	EJECT
***	SET TABLES
*
*
	SPACE	4,10
**	OPTAB	-  OPTION TABLE
*

OPTTAB	DW	OPTTABE		END OF THE TABLE
	DB	1

	DB	'HEL','P'+200Q,HELPI

OPTTABE	DB	0
	SPACE	4,10
**	PRCTAB	-  PROCESSOR TABLE
*

PRCTAB	DS	0

HELPI	EQU	*-PRCTAB/2
	DW	HELP
	SPACE	4,10
.	SET	300A
	ERRNZ	*-.
	DS	DVD.ENT-.
	STL	'MAIN ENTRY POINT'
	EJECT
**	MAIN ENTRY POINT

NDDVD	EQU	*
	ERRNZ	*-DVD.ENT	MUST BE AT THE ENTRY POINT
	CALL	$TBRA
	DB	NDREAD-*	READ
	DB	NDWRITE-*	WRITE
	DB	NDREADR-*	READR
	DB	NDOPE-*		OPENR
	DB	NDOPE-*		OPENW
	DB	NDABT-*		OPENU
	DB	NDNOP-*		CLOSE
	DB	NDNOP-*		ABORT
	DB	NDMNT-*		MOUNT
	DB	NDLOAD-*	LOAD
	DB      NDRDY-*         READY

NDABT	MVI	A,EC.DDA	DEVICE DRIVER ABORT
	STC
	RET

NDOPE	EQU	*
NDNOP	ANA	A
	RET			DO NOTHING

NDREADR	EQU	*
	CALL    DREADR
	MVI	A,EC.EOF
	STC			EOF ON ALL READS
	RET

NDREAD	EQU	*
	CALL    DREAD
	MVI	A,EC.EOF
	STC			EOF ON ALL READS
	RET

NDWRITE	EQU     *
	CALL	DWRITE
	ANA     A
	RET

NDLOAD	EQU	*
        CALL    DLOAD
	CALL    PGINIT
	ANA	A
	RET

NDRDY	EQU	*
	CALL	DRDY
	ANA	A
	RET

NDMNT	EQU	*
	CALL	DMNT
	ANA	A
	RET

** Library stuff

	XTEXT	PGMAP

** Debug messages

DLOAD   EQU	*
 	PUSH    PSW
	PUSH	H
	LXI	H,MLOAD
	SCALL   .PRINT
	POP	H
	POP	PSW
	RET

DREADR	EQU	*
	PUSH    PSW
	PUSH	H
	LXI	H,MREADR
	SCALL   .PRINT
	POP	H
	POP	PSW
	RET

DREAD	EQU	*
	PUSH    PSW
	PUSH	H
	LXI	H,MREAD
	SCALL   .PRINT
	POP	H
	POP	PSW
	RET

DWRITE	EQU	*
	PUSH    PSW
	PUSH	H
	LXI	H,MWRITE
	SCALL   .PRINT
	POP	H
	POP	PSW
	RET

DRDY	EQU	*
	PUSH    PSW
	PUSH	H
	LXI	H,MRDY
	SCALL   .PRINT
	POP	H
	POP	PSW
	RET

DMNT	EQU	*
	PUSH    PSW
	PUSH	H
	LXI	H,MMNT
	SCALL   .PRINT
	POP	H
	POP	PSW
	RET		

MLOAD	DB	12Q,'RD: LOAD',212Q
MREAD   DB      12Q,'RD: READ',212Q
MREADR  DB      12Q,'RD: READ REGARDLESS',212Q
MWRITE  DB      12Q,'RD: WRITE',212Q
MRDY    DB      12Q,'RD: READY',212Q
MMNT    DB      12Q,'RD: MOUNT',212Q

	XTEXT	TBRA
	XTEXT	TYPTX
	DB	'RW'		DUMY ADDRESS FOR RELOCATION
	DS	32		PATCH AREA

	LON	G

	END
